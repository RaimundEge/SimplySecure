<div class="progress" *ngIf="spinner == 'show'">
  <mat-spinner>wait</mat-spinner>
</div>
<h3>Advanced Encryption Standard</h3>
<p>The Advanced Encryption Standard (AES) is a specification for the encryption of electronic data established by the
  U.S.
  National Institute of Standards and Technology (NIST). AES uses a fixed block size of 128 bits, and a key size of 128,
  192, or 256 bits. Standard block cipher modes of operation such as Electronic Codebook (ECB) or Cipher Block Chaining
  (CBC)
  are used to accommodate files.<br> Keys can be generated using password-based algorithm, or specified manually. When
  using
  CBC an initialization vector must also be provided.
</p>
<p>
  Complete the 3 steps below:<br> (1) select whether you want to encrypt or decrypt, (2) select your file: either a plain file, or a
  previously encrypted file; (3) prepare the key by selecting the
  appropriate parameters; and then start the process.
</p>
<form (ngSubmit)="onSubmit()" #aesForm="ngForm">

  <mat-horizontal-stepper #stepper>
    <mat-step>
      <form>
        <ng-template matStepLabel>Select operation: {{request.op}} </ng-template>
        <mat-radio-group [(ngModel)]="request.op" name={{request.algorithm+request.op}}>
          <mat-radio-button value="encrypt">encrypt</mat-radio-button>&nbsp;
          <mat-radio-button value="decrypt">decrypt</mat-radio-button>
        </mat-radio-group>
        &nbsp;
        <button mat-mini-fab matStepperNext>
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </form>
    </mat-step>
    <mat-step>
      <form>
        <ng-template matStepLabel>Select file for operation: {{request.fileName}}</ng-template>
        &nbsp;<button mat-mini-fab matStepperPrevious>
          <mat-icon>arrow_back</mat-icon>
        </button>&nbsp;&nbsp;&nbsp;
        <mat-form-field appearance="standard">
          <mat-select [(ngModel)]="request.fileName" name="fileName" placeholder="select file to {{request.op}}"
            required>
            <mat-option>
              <!-- <input type="file" (change)="setFile($event)"> -->
              <button type="button" (click)="fileInput.click()">Choose File</button>
              <input hidden (change)="setFile($event)" #fileInput type="file" id="file">
            </mat-option>
            <mat-optgroup label="Existing Files">
              <mat-option *ngFor="let file of authService.files" [value]="file.name">
                {{file.name}}
              </mat-option>
            </mat-optgroup>
          </mat-select>
          <mat-error>you must select a file</mat-error>
        </mat-form-field>
        {{request.fileName}} &nbsp; {{filemsg}}
        &nbsp;&nbsp;&nbsp;<button mat-mini-fab matStepperNext>
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </form>
    </mat-step>
    <mat-step>
      <form>
        <ng-template matStepLabel>Prepare key:</ng-template>
        <div *ngIf="!gotKey()">
          &nbsp;&nbsp;&nbsp;(Or, you can preselect an existing key from the "Key Management" tab)
          <div class="keydata">
            <mat-grid-list cols="3" rowHeight="100px">
              <mat-grid-tile>
                <mat-grid-tile-header>Key size:</mat-grid-tile-header>
                <mat-grid-tile-footer>
                  <mat-radio-group [(ngModel)]="request.keySizeString" name="aes.keySize">
                    <mat-radio-button value="128">128</mat-radio-button>&nbsp;
                    <mat-radio-button value="192">192</mat-radio-button>&nbsp;
                    <mat-radio-button value="256">256</mat-radio-button>
                  </mat-radio-group>
                </mat-grid-tile-footer>
              </mat-grid-tile>
              <mat-divider [vertical]="true"></mat-divider>
              <mat-grid-tile>
                <mat-grid-tile-header>Key mode:</mat-grid-tile-header>
                <mat-grid-tile-footer>
                  <mat-radio-group [(ngModel)]="request.mode" name="aes.mode">
                    <mat-radio-button value="ECB">Electronic Codebook</mat-radio-button>&nbsp;
                    <mat-radio-button value="CBC">Cipher Block Chaining</mat-radio-button>
                  </mat-radio-group>
                </mat-grid-tile-footer>
              </mat-grid-tile>
              <mat-grid-tile>
                <mat-grid-tile-header>Key style:</mat-grid-tile-header>
                <mat-grid-tile-footer>
                  <mat-radio-group [(ngModel)]="request.keyStyle" name="aes.keyStyle">
                    <mat-radio-button value="password">password</mat-radio-button>&nbsp;
                    <mat-radio-button value="hex">hex data</mat-radio-button>
                  </mat-radio-group>
                </mat-grid-tile-footer>
              </mat-grid-tile>
            </mat-grid-list>
            <fieldset>
              <legend>Key data:</legend>
              <div *ngIf="request.keyStyle=='password'" appearance="legacy">
                <mat-form-field>
                  <input matInput type="password" [(ngModel)]="request.password" name="password" placeholder="Password"
                    size="10" required />
                  <mat-error>password is required</mat-error>
                </mat-form-field>
              </div>
              <div *ngIf="request.keyStyle=='hex'">
                <span>
                  <mat-form-field appearance="legacy">
                    <input matInput type="text" [(ngModel)]="request.keyData" name="keyData"
                      placeholder="Key data in {{request.keySizeString/8}} hex digits "
                      size="{{request.keySizeString/4}}" required pattern="[a-fA-F0-9]{16,}" />
                    <mat-error>iv data is required</mat-error>
                  </mat-form-field>
                  &nbsp;&nbsp;
                  <mat-form-field *ngIf="request.mode!=='ECB'" appearance="legacy">
                    <input matInput type="text" [(ngModel)]="request.ivData" name="ivData"
                      placeholder="Initialization vector in {{request.ivSize/8}} hex digits " size="{{request.ivSize/4}}" required pattern="[a-fA-F0-9]{16,}" />
                    <mat-error>iv data is required</mat-error>
                  </mat-form-field>
                </span>
              </div>
            </fieldset>
            <p>
              <span *ngIf="authService.selectedKey !== null">Current selection is: {{getKeyData()}}</span>
            </p>
          </div>
        </div>
        <div *ngIf="gotKey()">
          Selected Key: {{authService.userId + "-" + authService.selectedKey}}: {{getKeyData()}}
          &nbsp;&nbsp;&nbsp; <button mat-button-raised (click)="resetKey()">Reset</button>
        </div>
        <div *ngIf="check()">
          <span>
            &nbsp; Let's go &nbsp;
            <button mat-button-raised type="button" (click)="onSubmit()">
              <mat-icon>check</mat-icon> {{request.op}}
            </button>
          </span>          
        </div>
        <span mat-warn>&nbsp; {{message}}</span>
      </form>
    </mat-step>
  </mat-horizontal-stepper>
</form>